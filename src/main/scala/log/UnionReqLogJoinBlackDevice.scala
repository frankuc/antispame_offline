package log

class UnionReqLogJoinBlackDevice extends Log {
  var logName: String = "UnionReqLogJoinBlackDevice"

  def logString(date:String, hour:String, windowSize:Int): String ={
  val sqlQuery:String =
    s"""
      |WITH ori_req AS (
      |    SELECT  request_id,
      |            union_api_status,
      |            status_code,
      |            rit,
      |            site_id,
      |            site_name,
      |            media_id,
      |            media_name,
      |            ad_slot_type,
      |            device_id,
      |            user_agent,
      |            device_type,
      |            ip,
      |            IF(ip is not null AND ip != '', IF(SIZE(split(ip, '\\.')) = 4, concat(split(ip, '\\.')[0], '.', split(ip, '\\.')[1], '.', split(ip, '\\.')[2]), ip), ip) as ipc,
      |            latitude,
      |            longitude,
      |            version,
      |            is_paid_app,
      |            os_type,
      |            os_version,
      |            device_vendor,
      |            device_model,
      |            model_price,
      |            connect_type,
      |            screen_width,
      |            screen_height,
      |            ad_show_position,
      |            log_timestamp,
      |            mac,
      |            imei,
      |            wifi_ssid,
      |            imsi,
      |            union_imei,
      |            oaid,
      |            sha1,
      |            idfv,
      |            global_did,
      |            applog_did,
      |            wifi_mac,
      |            did,
      |            rom_version,
      |            ad_sdk_version,
      |            power_on_timestamp,
      |            system_compiling_time,
      |            system_build_version,
      |            screen_orientation,
      |            city_id,
      |            province_id,
      |            screen_bright,
      |            is_screen_off,
      |            battery_remaining_pct,
      |            cpu_max_freq,
      |            cpu_min_freq,
      |            cpu_num,
      |            is_charging,
      |            free_space_in,
      |            sdcard_size,
      |            is_rooted,
      |            app_running_time,
      |            is_low_power,
      |            boot_timestamp,
      |            sec_did,
      |            whale_decision,
      |            is_reverse,
      |            is_limit_delivery,
      |            front_intercept_decision,
      |            front_intercept_detail,
      |            mediation_req_type,
      |            is_refuse,
      |            waterfall_type,
      |            is_waterfall_cache,
      |            is_system_adb,
      |            is_click_acb,
      |            last_show_report_detail,
      |            sdk_plugin_version,
      |            access_method,
      |            union_imei_source,
      |            carrier_id,
      |            android_id,
      |            engine_status_code,
      |            district_id,
      |            sec_did_2,
      |            antispam_dispose,
      |            antispam_list_rules,
      |            union_imei_first_time_difference,
      |            p_date,
      |            hour,
      |            ad_source,
      |            final_decision,
      |            mark_status
      |    FROM    union_anti.dwd_union_anti_request_daily
      |    WHERE   p_date >= FROM_UNIXTIME(UNIX_TIMESTAMP('${date} ${hour}', 'yyyyMMdd HH') - 3600 * ${windowSize - 1}, 'yyyyMMdd')
      |    AND     p_date <= '${date}'
      |    AND     concat(p_date, ' ', hour) >= FROM_UNIXTIME(UNIX_TIMESTAMP('${date} ${hour}', 'yyyyMMdd HH') - 3600 * ${windowSize - 1}, 'yyyyMMdd HH')
      |    AND     concat(p_date, ' ', hour) <= concat('${date}', ' ', '${hour}')
      |),
      |-- 当天的全量设备策略产出的处置设备拼接的当天请求数据，并排除掉白名单设备策略请求
      |black_dev AS (
      |    SELECT  request_id
      |    FROM    union_anti.ads_union_board_black_name_list_req_daily
      |    WHERE   p_date = '${date}'
      |    AND     hit_policy != '900002' -- 删除设备白名单
      |    AND     hit_policy != '900001' -- 删除设备白名单
      |    AND     hit_policy != '0'
      |    GROUP BY
      |            request_id
      |),
      |${logName} AS (
      |SELECT  tb1.request_id AS req_id,
      |        union_api_status,
      |        status_code,
      |        rit,
      |        site_id,
      |        site_name,
      |        media_id,
      |        media_name,
      |        ad_slot_type,
      |        device_id,
      |        user_agent,
      |        device_type,
      |        ip,
      |        ipc,
      |        latitude,
      |        longitude,
      |        version,
      |        is_paid_app,
      |        os_type,
      |        os_version,
      |        device_vendor,
      |        device_model,
      |        model_price,
      |        connect_type,
      |        screen_width,
      |        screen_height,
      |        ad_show_position,
      |        log_timestamp,
      |        mac,
      |        imei,
      |        wifi_ssid,
      |        imsi,
      |        union_imei,
      |        oaid,
      |        sha1,
      |        idfv,
      |        global_did,
      |        applog_did,
      |        wifi_mac,
      |        did,
      |        rom_version,
      |        ad_sdk_version,
      |        power_on_timestamp,
      |        system_compiling_time,
      |        system_build_version,
      |        screen_orientation,
      |        city_id,
      |        province_id,
      |        screen_bright,
      |        is_screen_off,
      |        battery_remaining_pct,
      |        cpu_max_freq,
      |        cpu_min_freq,
      |        cpu_num,
      |        is_charging,
      |        free_space_in,
      |        sdcard_size,
      |        is_rooted,
      |        app_running_time,
      |        is_low_power,
      |        boot_timestamp,
      |        sec_did,
      |        whale_decision,
      |        is_reverse,
      |        is_limit_delivery,
      |        front_intercept_decision,
      |        front_intercept_detail,
      |        mediation_req_type,
      |        is_refuse,
      |        waterfall_type,
      |        is_waterfall_cache,
      |        is_system_adb,
      |        is_click_acb,
      |        last_show_report_detail,
      |        sdk_plugin_version,
      |        access_method,
      |        union_imei_source,
      |        carrier_id,
      |        android_id,
      |        engine_status_code,
      |        district_id,
      |        sec_did_2,
      |        antispam_dispose,
      |        antispam_list_rules,
      |        union_imei_first_time_difference,
      |        IF(tb2.request_id IS NOT NULL, 1, 0) AS hit_black_device_flag,
      |        p_date,
      |        hour,
      |        ad_source,
      |        final_decision,
      |        mark_status
      |FROM    ori_req tb1
      |LEFT JOIN
      |        black_dev tb2
      |ON      tb1.request_id = tb2.request_id
      |
      |)
      |""".stripMargin

    sqlQuery
  }
}
